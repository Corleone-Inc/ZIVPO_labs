# Лабораторная работа 3
выполнили Дзюба Д.В и Алиев С.Г

## Код программы
**==================================================================================**

using System;
using System.Collections.Generic;	
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.IO;
using System.Runtime.InteropServices;

class Program
{
    //системный вызов
    [DllImport("kernel32.dll")]
    static extern IntPtr CreateFile(string lpFileName, uint dwDesiredAccess,
        uint dwShareMode, IntPtr lpSecurityAttributes, uint dwCreationDisposition,
        uint dwFlagsAndAttributes, IntPtr hTemplateFile);

    static void Main()
    {
        //консоль
        Console.WriteLine("\n===============================================");
        Console.WriteLine("Лабораторная работа №3");
        Console.WriteLine("Выполнили: Алиев Садык, Дзюба Данил");
        Console.WriteLine("===============================================\n");
        //системный вызов
        string testFile = Path.Combine(Environment.GetFolderPath(
            Environment.SpecialFolder.MyDocuments), "test.txt");

        IntPtr fileHandle = CreateFile(testFile, 0x40000000, 0,
            IntPtr.Zero, 2, 0x80, IntPtr.Zero);

        Console.WriteLine(fileHandle != (IntPtr)(-1) ?
            "Системный вызов CreateFile выполнен" :
            "Ошибка системного вызова");

        // Вывод файлов средствами .NET
        string docsPath = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
        Console.WriteLine($"\nСодержимое {docsPath}:");

        foreach (var dir in Directory.GetDirectories(docsPath))
            Console.WriteLine($"{Path.GetFileName(dir)}");

        foreach (var file in Directory.GetFiles(docsPath))
            Console.WriteLine($"{Path.GetFileName(file)}");
        
        Console.ReadKey();

    }
}

**==================================================================================**

<img src="https://github.com/Corleone-Inc/ZIVPO_labs/blob/main/lab3/images/Снимок%20экрана%202025-11-16%20204532.jpg" width="800" height="600">

## Описание работы программы
Программа запускает консольное окно и выводит информацию о лабораторной работе и фамилии выполнивших ее студентов. Затем программа выполняет системный вызов Windows API - создает временный файл test.txt в папке Documents текущего пользователя с помощью функции CreateFile из kernel32.dll. После этого программа получает путь к папке Documents, считывает все подкаталоги и файлы в этой папке и выводит их список в консоль. В конце программа ожидает нажатия любой клавиши пользователем, чтобы консольное окно не закрывалось сразу после выполнения всех операций.

## Ход Работы

**Шаг 1**
Для начала превратили проект в exe-файл. И дизассемблировали его через IDA
Видим, что все функции и программы легко прочитать и понять
**Дизассемблированный код до обсфукации**
<img src="https://github.com/Corleone-Inc/ZIVPO_labs/blob/main/lab3/images/photo_5246957968828337649_y.jpg" width="800" height="600">
<img src="https://github.com/Corleone-Inc/ZIVPO_labs/blob/main/lab3/images/photo_5246957968828337650_y.jpg" width="800" height="600">

**Шаг 2**
Затем загрузили файл в обсфукатор. Программа была написана на языке C#, поэтому был выбран обсфукатор ___yetAnotherObfuscator___
https://github.com/0xb11a1/yetAnotherObfuscator

<img src="https://github.com/Corleone-Inc/ZIVPO_labs/blob/main/lab3/images/photo_5246957968828337625_y.jpg" width="800" height="600">

**Шаг 3**

Обсфуцированный файл дизассемблировали в IDA. Получили вот такой результат:
<img src="https://github.com/Corleone-Inc/ZIVPO_labs/blob/main/lab3/images/photo_5246957968828337645_y.jpg" width="800" height="600">
<img src="https://github.com/Corleone-Inc/ZIVPO_labs/blob/main/lab3/images/photo_5246957968828337646_y.jpg" width="800" height="600">

**Шаг 4**
Сравним 2 файла - до и после обсфукации

После сравнения двух дизассемблированных файлов можно отметить следующие изменения, появившиеся после обфускации:

Мы видим, что после обфускации все строки были полностью заменены на наборы Base64-подобных последовательностей. В оригинальном файле присутствовали обычные читаемые строки: заголовок лабораторной, имена исполнителей, сообщения об ошибках, строка "test.txt", а также разделители. В обфусцированном варианте ни одна строка не хранится в открытом виде — вместо них вставлены зашифрованные константы, которые расшифровываются на лету специальной функцией.

Также изменились имена всех пользовательских сущностей. Класс Program превратился в UHJvZ3JhbUFB, а функция для расшифровки строк получила имя '0xb11a1'. Это затрудняет анализ структуры кода и делает невозможным понимание логики по именам.

Появилась новая функция с именем '0xb11a1'. В ней реализована логика расшифровки строк: происходит преобразование Base64, вычисление MD5-хэша ключа, создание TripleDES-дешифратора и расшифровка данных. Эта функция вызывается каждый раз, когда программе требуется получить строковое значение. В оригинальном файле подобной функции не было — строки использовались напрямую.

Вызовы Console.WriteLine, Path.Combine, String.Concat и другие операции со строками теперь используют обёртку: вместо передачи простого литерала передаётся зашифрованная строка, которая затем расшифровывается через '0xb11a1'. В результате формируется та же строка, что была в оригинальном приложении, но она появляется только во время выполнения.

При этом логика программы осталась прежней. Как и раньше, используется системный вызов CreateFile, выполняется проверка на ошибку, выводится содержимое каталога и список файлов, затем ожидается нажатие клавиши. Все инструкции, управляющие поведение программы, полностью совпадают с версией до обфускации, изменилась только обработка строк и имена элементов.

Таким образом, основная разница между файлами заключается в полном скрытии строковых констант, переименовании всех пользователей классов и методов, а также добавлении специального шифрующего/дешифрующего блока. Это делает дизассемблированный код значительно более затруднительным для анализа, но не изменяет саму бизнес-логику программы.
